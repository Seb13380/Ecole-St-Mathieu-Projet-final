{% extends "layouts/dashboard.twig" %}

{% block title %}Analytics et Statistiques
{% endblock %}

{% block styles %}
	<style>
		.stats-card {
			transition: transform 0.3s ease, box-shadow 0.3s ease;
		}

		.stats-card:hover {
			transform: translateY(-4px);
			box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
		}

		.chart-container {
			background: white;
			border-radius: 12px;
			padding: 1.5rem;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
			margin-bottom: 1.5rem;
			transition: box-shadow 0.3s ease;
		}

		.chart-container:hover {
			box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
		}

		.loading-spinner {
			border: 3px solid #f3f3f3;
			border-top: 3px solid #3498db;
			border-radius: 50%;
			width: 20px;
			height: 20px;
			animation: spin 1s linear infinite;
		}

		@keyframes spin {
			0% {
				transform: rotate(0deg);
			}
			100% {
				transform: rotate(360deg);
			}
		}

		.progress-bar {
			transition: width 0.5s ease-in-out;
		}

		.btn-period {
			transition: all 0.3s ease;
		}

		.btn-period.active {
			background: linear-gradient(135deg, #3b82f6, #1d4ed8);
			transform: scale(1.05);
		}
	</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
	<div class="flex justify-between items-center mb-6">
		<div>
			<h1 class="text-3xl font-bold text-gray-800">📊 Analytics et Statistiques</h1>
			<p class="text-gray-600 mt-2">Tableau de bord des performances du site en temps réel</p>
		</div>

		<!-- Boutons de période -->
		<div class="flex gap-2">
			<button onclick="loadPeriod(7)" class="btn-period px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-all">7 jours</button>
			<button onclick="loadPeriod(30)" class="btn-period active px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-all">30 jours</button>
			<button onclick="loadPeriod(90)" class="btn-period px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-all">90 jours</button>
			<button onclick="exportData()" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-all">📤 Export CSV</button>
		</div>
	</div>

	<!-- Indicateur de chargement -->
	<div id="loadingIndicator" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
		<div class="bg-white p-6 rounded-lg shadow-xl">
			<div class="flex items-center space-x-3">
				<div class="loading-spinner"></div>
				<span class="text-gray-700">Chargement des données...</span>
			</div>
		</div>
	</div>

	<!-- Statistiques générales -->
	<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
		<div class="stats-card bg-gradient-to-r from-purple-500 to-purple-600 rounded-xl p-6 text-white">
			<div class="text-3xl font-bold" id="totalVisits">{{ generalStats.totalVisits | number_format }}</div>
			<div class="text-purple-100">Total des visites</div>
			<div class="mt-2 text-sm text-purple-200">
				<span id="visitsGrowth" class="inline-flex items-center">
					{% if generalStats.visitsGrowth > 0 %}📈 +{{ generalStats.visitsGrowth }}%{% else %}📉
						{{ generalStats.visitsGrowth }}%
					{% endif %}
				</span>
				vs période précédente
			</div>
		</div>

		<div class="stats-card bg-gradient-to-r from-pink-500 to-pink-600 rounded-xl p-6 text-white">
			<div class="text-3xl font-bold" id="uniqueVisitors">{{ generalStats.uniqueVisitors | number_format }}</div>
			<div class="text-pink-100">Visiteurs uniques</div>
			<div class="mt-2 text-sm text-pink-200">
				<span id="visitorsGrowth" class="inline-flex items-center">
					{% if generalStats.visitorsGrowth > 0 %}📈 +{{ generalStats.visitorsGrowth }}%{% else %}📉
						{{ generalStats.visitorsGrowth }}%
					{% endif %}
				</span>
				vs période précédente
			</div>
		</div>

		<div class="stats-card bg-gradient-to-r from-blue-500 to-blue-600 rounded-xl p-6 text-white">
			<div class="text-3xl font-bold" id="avgResponseTime">{{ generalStats.avgResponseTime }}ms</div>
			<div class="text-blue-100">Temps de réponse moyen</div>
			<div class="mt-2 text-sm text-blue-200">
				<span class="inline-flex items-center">
					{% if generalStats.avgResponseTime < 500 %}⚡ Excellent{% elseif generalStats.avgResponseTime < 1000 %}✅ Bon{% else %}⚠️ À améliorer
					{% endif %}
				</span>
			</div>
		</div>

		<div class="stats-card bg-gradient-to-r from-green-500 to-green-600 rounded-xl p-6 text-white">
			<div class="text-3xl font-bold" id="successRate">{{ generalStats.successRate }}%</div>
			<div class="text-green-100">Taux de succès</div>
			<div class="mt-2 text-sm text-green-200">
				<span class="inline-flex items-center">
					{% if generalStats.successRate > 95 %}🎯 Excellent{% elseif generalStats.successRate > 90 %}✅ Bon{% else %}⚠️ À surveiller
					{% endif %}
				</span>
			</div>
		</div>
	</div>

	<!-- Graphique des visites quotidiennes -->
	<div class="chart-container">
		<div class="flex justify-between items-center mb-4">
			<h2 class="text-xl font-semibold">📈 Évolution des visites</h2>
			<div class="text-sm text-gray-500">
				<span id="lastUpdate">Dernière mise à jour:
					{{ "now"|date("d/m/Y H:i") }}</span>
			</div>
		</div>
		<canvas id="dailyVisitsChart" width="400" height="100"></canvas>
	</div>

	<div
		class="grid grid-cols-1 lg:grid-cols-2 gap-8">
		<!-- Types d'appareils -->
		<div class="chart-container">
			<h2 class="text-xl font-semibold mb-4">📱 Types d'appareils</h2>
			<div class="space-y-4" id="deviceTypesContainer">
				<div class="flex justify-between items-center">
					<div class="flex items-center space-x-2">
						<span>🖥️ Desktop</span>
						<div class="bg-gray-200 rounded-full h-2 w-32">
							<div class="bg-blue-500 h-2 rounded-full progress-bar" style="width: {{ deviceTypes.desktop }}%" id="desktopBar"></div>
						</div>
					</div>
					<span class="font-bold" id="desktopPercent">{{ deviceTypes.desktop }}%</span>
				</div>
				<div class="flex justify-between items-center">
					<div class="flex items-center space-x-2">
						<span>📱 Mobile</span>
						<div class="bg-gray-200 rounded-full h-2 w-32">
							<div class="bg-green-500 h-2 rounded-full progress-bar" style="width: {{ deviceTypes.mobile }}%" id="mobileBar"></div>
						</div>
					</div>
					<span class="font-bold" id="mobilePercent">{{ deviceTypes.mobile }}%</span>
				</div>
				<div class="flex justify-between items-center">
					<div class="flex items-center space-x-2">
						<span>📟 Tablette</span>
						<div class="bg-gray-200 rounded-full h-2 w-32">
							<div class="bg-yellow-500 h-2 rounded-full progress-bar" style="width: {{ deviceTypes.tablet }}%" id="tabletBar"></div>
						</div>
					</div>
					<span class="font-bold" id="tabletPercent">{{ deviceTypes.tablet }}%</span>
				</div>
			</div>
		</div>

		<!-- Pages populaires -->
		<div class="chart-container">
			<h2 class="text-xl font-semibold mb-4">🔥 Pages populaires</h2>
			<div id="popularPagesList" class="space-y-2 max-h-60 overflow-y-auto">
				{% for page in popularPages %}
					<div class="flex justify-between items-center py-2 px-3 hover:bg-gray-50 rounded-lg transition-colors">
						<span class="text-sm truncate font-medium">{{ page.route }}</span>
						<span class="font-bold text-blue-600">{{ page.visits }}</span>
					</div>
				{% endfor %}
			</div>
		</div>
	</div>

	<!-- Trafic par heure -->
	<div class="chart-container mt-8">
		<h2 class="text-xl font-semibold mb-4">� Trafic par heure de la journée</h2>
		<canvas id="hourlyTrafficChart" width="400" height="100"></canvas>
	</div>

	<!-- Section supplémentaire: Top erreurs et performances -->
	<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
		<div class="chart-container">
			<h2 class="text-xl font-semibold mb-4">⚠️ Pages avec erreurs</h2>
			<div
				id="errorPagesList" class="space-y-2 max-h-60 overflow-y-auto"><!-- Sera rempli dynamiquement -->
			</div>
		</div>

		<div class="chart-container">
			<h2 class="text-xl font-semibold mb-4">🌐 Navigateurs populaires</h2>
			<div
				id="browsersList" class="space-y-2 max-h-60 overflow-y-auto"><!-- Sera rempli dynamiquement -->
			</div>
		</div>
	</div>
</div>

{% block scripts %}
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<script>
		// Variables globales pour les graphiques
let dailyChart,
hourlyChart;
let currentPeriod = 30;

// Données initiales
let dailyData = {{ dailyVisits | json_encode | raw }};
let hourlyData = {{ hourlyTraffic | json_encode | raw }};

document.addEventListener('DOMContentLoaded', function () {
initializeCharts();

// Auto-refresh toutes les 5 minutes
setInterval(() => {
refreshData();
}, 5 * 60 * 1000);
});

function initializeCharts() { // Graphique des visites quotidiennes
const dailyCtx = document.getElementById('dailyVisitsChart').getContext('2d');
dailyChart = new Chart(dailyCtx, {
type: 'line',
data: {
labels: dailyData.map(d => new Date(d.date).toLocaleDateString('fr-FR', {
day: '2-digit',
month: '2-digit'
})),
datasets: [
{
label: 'Visites',
data: dailyData.map(d => d.visits),
borderColor: 'rgb(59, 130, 246)',
backgroundColor: 'rgba(59, 130, 246, 0.1)',
tension: 0.4,
fill: true,
borderWidth: 3,
pointBackgroundColor: 'rgb(59, 130, 246)',
pointBorderColor: '#ffffff',
pointBorderWidth: 2,
pointRadius: 5,
pointHoverRadius: 8
}
]
},
options: {
responsive: true,
interaction: {
intersect: false,
mode: 'index'
},
plugins: {
legend: {
display: false
},
tooltip: {
backgroundColor: 'rgba(0, 0, 0, 0.8)',
titleColor: '#ffffff',
bodyColor: '#ffffff',
borderColor: 'rgb(59, 130, 246)',
borderWidth: 1
}
},
scales: {
y: {
beginAtZero: true,
ticks: {
precision: 0
},
grid: {
color: 'rgba(0, 0, 0, 0.1)'
}
},
x: {
grid: {
color: 'rgba(0, 0, 0, 0.1)'
}
}
}
}
});

// Graphique du trafic horaire
const hourlyCtx = document.getElementById('hourlyTrafficChart').getContext('2d');
hourlyChart = new Chart(hourlyCtx, {
type: 'bar',
data: {
labels: hourlyData.map(d => d.hour + 'h'),
datasets: [
{
label: 'Visites',
data: hourlyData.map(d => d.visits),
backgroundColor: function (context) {
const hour = parseInt(context.parsed.x);
if (hour >= 8 && hour<= 18) {
                        return 'rgba(34, 197, 94, 0.8)';
                    } else if (hour> = 19 && hour<= 22) {
                        return 'rgba(59, 130, 246, 0.8)';
                    } else {
                        return 'rgba(156, 163, 175, 0.5)';
                    }
                }, borderColor: function(context) {
                    const hour = parseInt(context.parsed.x);
                    if (hour> = 8 && hour<= 18) {
                        return 'rgb(34, 197, 94)';
                    } else if (hour> = 19 && hour <= 22) {
return 'rgb(59, 130, 246)';
} else {
return 'rgb(156, 163, 175)';
}
},
borderWidth: 2,
borderRadius: 4,
borderSkipped: false
}
]
},
options: {
responsive: true,
plugins: {
legend: {
display: false
},
tooltip: {
backgroundColor: 'rgba(0, 0, 0, 0.8)',
titleColor: '#ffffff',
bodyColor: '#ffffff',
borderColor: 'rgb(34, 197, 94)',
borderWidth: 1
}
},
scales: {
y: {
beginAtZero: true,
ticks: {
precision: 0
},
grid: {
color: 'rgba(0, 0, 0, 0.1)'
}
},
x: {
grid: {
color: 'rgba(0, 0, 0, 0.1)'
}
}
}
}
});
}

// Fonction pour changer de période
async function loadPeriod(days) {
try {
showLoading();
currentPeriod = days;

// Mettre à jour les boutons actifs
document.querySelectorAll('.btn-period').forEach(btn => {
btn.classList.remove('active', 'bg-blue-500', 'hover:bg-blue-600');
btn.classList.add('bg-gray-500', 'hover:bg-gray-600');
});
event.target.classList.remove('bg-gray-500', 'hover:bg-gray-600');
event.target.classList.add('active', 'bg-blue-500', 'hover:bg-blue-600');

const response = await fetch (`/directeur/analytics/data?period=${days}&type=all`);
const result = await response.json();

if (result.success) {
updateStats(result.data.general);
updateCharts(result.data.daily, result.data.hourly);
updateDeviceTypes(result.data.devices);
updatePopularPages(result.data.pages);
updateErrorPages(result.data.errors || []);
updateBrowsers(result.data.browsers || []);
updateLastUpdateTime();
} else {
throw new Error(result.message);
} hideLoading();
} catch (error) {
console.error('Erreur:', error);
hideLoading();
showNotification('Erreur lors du chargement des données: ' + error.message, 'error');
}
}

function updateStats(stats) {
document.getElementById('totalVisits').textContent = stats.totalVisits.toLocaleString('fr-FR');
document.getElementById('uniqueVisitors').textContent = stats.uniqueVisitors.toLocaleString('fr-FR');
document.getElementById('avgResponseTime').textContent = stats.avgResponseTime + 'ms';
document.getElementById('successRate').textContent = stats.successRate + '%';

// Mettre à jour les indicateurs de croissance
updateGrowthIndicator('visitsGrowth', stats.visitsGrowth);
updateGrowthIndicator('visitorsGrowth', stats.visitorsGrowth);
}

function updateGrowthIndicator(elementId, growth) {
const element = document.getElementById(elementId);
if (element) {
const icon = growth > 0 ? '📈 +' : '📉 ';
element.textContent = icon + growth + '%';
}
}

function updateCharts(daily, hourly) { // Mettre à jour le graphique quotidien
dailyData = daily;
dailyChart.data.labels = daily.map(d => new Date(d.date).toLocaleDateString('fr-FR', {
day: '2-digit',
month: '2-digit'
}));
dailyChart.data.datasets[0].data = daily.map(d => d.visits);
dailyChart.update('active');

// Mettre à jour le graphique horaire
hourlyData = hourly;
hourlyChart.data.datasets[0].data = hourly.map(d => d.visits);
hourlyChart.update('active');
}

function updateDeviceTypes(devices) {
document.getElementById('desktopPercent').textContent = devices.desktop + '%';
document.getElementById('mobilePercent').textContent = devices.mobile + '%';
document.getElementById('tabletPercent').textContent = devices.tablet + '%';

// Mettre à jour les barres de progression avec animation
setTimeout(() => {
document.getElementById('desktopBar').style.width = devices.desktop + '%';
document.getElementById('mobileBar').style.width = devices.mobile + '%';
document.getElementById('tabletBar').style.width = devices.tablet + '%';
}, 100);
}

function updatePopularPages(pages) {
const container = document.getElementById('popularPagesList');
container.innerHTML = pages.map(page => `
        <div class="flex justify-between items-center py-2 px-3 hover:bg-gray-50 rounded-lg transition-colors">
            <span class="text-sm truncate font-medium">${
page.route
}</span>
            <span class="font-bold text-blue-600">${
page.visits
}</span>
        </div>
    `).join('');
}

function updateErrorPages(errors) {
const container = document.getElementById('errorPagesList');
if (errors.length === 0) {
container.innerHTML = '<div class="text-center text-gray-500 py-4">✅ Aucune erreur récente</div>';
} else {
container.innerHTML = errors.map(error => `
            <div class="flex justify-between items-center py-2 px-3 hover:bg-red-50 rounded-lg transition-colors">
                <span class="text-sm truncate font-medium">${
error.route
}</span>
                <span class="font-bold text-red-600">${
error.errors
}</span>
            </div>
        `).join('');
}
}

function updateBrowsers(browsers) {
const container = document.getElementById('browsersList');
if (browsers.length === 0) {
container.innerHTML = '<div class="text-center text-gray-500 py-4">Aucune donnée disponible</div>';
} else {
container.innerHTML = browsers.map(browser => `
            <div class="flex justify-between items-center py-2 px-3 hover:bg-gray-50 rounded-lg transition-colors">
                <span class="text-sm truncate font-medium">${
getBrowserIcon(browser.browser)
} ${
browser.browser
}</span>
                <span class="font-bold text-gray-600">${
browser.visits
}</span>
            </div>
        `).join('');
}
}

function getBrowserIcon(browser) {
const icons = {
'Chrome': '🟢',
'Firefox': '🟠',
'Safari': '🔵',
'Edge': '🔷',
'Opera': '🔴',
'Internet Explorer': '🔷'
};
return icons[browser] || '🌐';
}

function updateLastUpdateTime() {
const now = new Date();
document.getElementById('lastUpdate').textContent = `Dernière mise à jour: ${
now.toLocaleDateString('fr-FR')
} ${
now.toLocaleTimeString('fr-FR')
}`;
}

function exportData() {
const startDate = new Date();
startDate.setDate(startDate.getDate() - currentPeriod);
const endDate = new Date();

window.open(`/directeur/analytics/export?startDate=${
startDate.toISOString()
}&endDate=${
endDate.toISOString()
}&format=csv`);
}

function refreshData() {
if (currentPeriod) {
loadPeriod(currentPeriod);
}
}

function showLoading() {
document.getElementById('loadingIndicator').classList.remove('hidden');
}

function hideLoading() {
document.getElementById('loadingIndicator').classList.add('hidden');
}

function showNotification(message, type = 'info') { // Créer une notification toast
const toast = document.createElement('div');
toast.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transition-all transform translate-x-full`;

if (type === 'error') {
toast.classList.add('bg-red-500', 'text-white');
} else {
toast.classList.add('bg-blue-500', 'text-white');
} toast.textContent = message;
document.body.appendChild(toast);

// Animation d'entrée
setTimeout(() => {
toast.classList.remove('translate-x-full');
}, 100);

// Suppression automatique après 3 secondes
setTimeout(() => {
toast.classList.add('translate-x-full');
setTimeout(() => {
document.body.removeChild(toast);
}, 300);
}, 3000);
}
	</script>
{% endblock %}
