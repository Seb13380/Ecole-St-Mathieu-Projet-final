{% extends "layouts/dashboard.twig" %}

{% block title %}Import Excel des familles
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
	<div
		class="bg-white rounded-lg shadow-md p-6">
		<!-- En-t√™te -->
		<div class="border-b border-gray-200 pb-4 mb-6">
			<h1 class="text-2xl font-bold text-gray-900 flex items-center">
				üìä Import Excel des familles
			</h1>
			<p class="text-gray-600 mt-2">
				Importez facilement toutes les familles et √©l√®ves depuis un fichier Excel
			</p>
		</div>

		<!-- Zone d'upload -->
		<div class="mb-8">
			<div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center bg-gray-50" id="dropZone">
				<div class="space-y-4">
					<div class="mx-auto w-12 h-12 text-gray-400">
						<svg fill="none" stroke="currentColor" viewbox="0 0 48 48">
							<path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
						</svg>
					</div>
					<div>
						<p class="text-lg font-medium text-gray-900">Glissez votre fichier Excel ici</p>
						<p class="text-gray-500">ou</p>
						<button type="button" class="mt-2 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" onclick="document.getElementById('fileInput').click()">
							S√©lectionner un fichier
						</button>
					</div>
					<p class="text-xs text-gray-500">Formats accept√©s: .xlsx, .xls</p>
				</div>
			</div>

			<form id="uploadForm" enctype="multipart/form-data" class="hidden">
				<input type="file" id="fileInput" name="excelFile" accept=".xlsx,.xls"/>
			</form>
		</div>

		<!-- Barre de progression -->
		<div id="progressSection" class="mb-6 hidden">
			<div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
				<div class="flex items-center justify-between mb-2">
					<span class="text-sm font-medium text-blue-900">Import en cours...</span>
					<span class="text-sm text-blue-700" id="progressText">0%</span>
				</div>
				<div class="w-full bg-blue-200 rounded-full h-2">
					<div class="bg-blue-600 h-2 rounded-full transition-all duration-300" id="progressBar" style="width: 0%"></div>
				</div>
			</div>
		</div>

		<!-- Zone de r√©sultats -->
		<div id="resultsSection" class="hidden">
			<div class="border-t border-gray-200 pt-6">
				<h3 class="text-lg font-medium text-gray-900 mb-4">R√©sultats de l'import</h3>
				<div id="resultsContent"></div>
			</div>
		</div>

		<!-- Informations sur le format -->
		<div class="mt-8 bg-blue-50 border border-blue-200 rounded-lg p-4">
			<h3 class="text-sm font-medium text-blue-900 mb-2">Format attendu du fichier Excel:</h3>
			<div class="text-sm text-blue-800 space-y-1">
				<p>‚Ä¢
					<strong>Colonne A:</strong>
					Responsable 1 (P√®re) - Format: "M. NOM Pr√©nom"</p>
				<p>‚Ä¢
					<strong>Colonne B:</strong>
					T√©l√©phone Responsable 1</p>
				<p>‚Ä¢
					<strong>Colonne C:</strong>
					Email Responsable 1</p>
				<p>‚Ä¢
					<strong>Colonne D:</strong>
					Responsable 2 (M√®re) - Format: "Mme NOM Pr√©nom"</p>
				<p>‚Ä¢
					<strong>Colonne E:</strong>
					Email Responsable 2</p>
				<p>‚Ä¢
					<strong>Colonne F:</strong>
					T√©l√©phone Responsable 2</p>
				<p>‚Ä¢
					<strong>Colonne G:</strong>
					Adresse</p>
				<p>‚Ä¢
					<strong>Colonne H:</strong>
					Code postal - Ville</p>
				<p>‚Ä¢
					<strong>Colonne I:</strong>
					Nom et pr√©nom enfant</p>
				<p>‚Ä¢
					<strong>Colonne J:</strong>
					Date naissance (DD/MM/YYYY)</p>
				<p>‚Ä¢
					<strong>Colonne K:</strong>
					Code niveau</p>
				<p>‚Ä¢
					<strong>Colonne L:</strong>
					Code classe</p>
			</div>
		</div>
	</div>
</div>

<!-- Script JavaScript pour l'upload -->
<script>
	document.addEventListener('DOMContentLoaded', function() {
	    const dropZone = document.getElementById('dropZone');
	    const fileInput = document.getElementById('fileInput');
	    const uploadForm = document.getElementById('uploadForm');
	    const progressSection = document.getElementById('progressSection');
	    const progressBar = document.getElementById('progressBar');
	    const progressText = document.getElementById('progressText');
	    const resultsSection = document.getElementById('resultsSection');
	    const resultsContent = document.getElementById('resultsContent');
	
	    // Drag & Drop
	    dropZone.addEventListener('dragover', function(e) {
	        e.preventDefault();
	        dropZone.classList.add('border-blue-500', 'bg-blue-50');
	    });
	
	    dropZone.addEventListener('dragleave', function(e) {
	        e.preventDefault();
	        dropZone.classList.remove('border-blue-500', 'bg-blue-50');
	    });
	
	    dropZone.addEventListener('drop', function(e) {
	        e.preventDefault();
	        dropZone.classList.remove('border-blue-500', 'bg-blue-50');
	        
	        const files = e.dataTransfer.files;
	        if (files.length > 0) {
	            handleFile(files[0]);
	        }
	    });
	
	    // S√©lection de fichier
	    fileInput.addEventListener('change', function(e) {
	        if (e.target.files.length > 0) {
	            handleFile(e.target.files[0]);
	        }
	    });
	
	    function handleFile(file) {
	        // V√©rification du format
	        const allowedTypes = [
	            'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
	            'application/vnd.ms-excel'
	        ];
	        
	        if (!allowedTypes.includes(file.type)) {
	            alert('Format de fichier non support√©. Utilisez .xlsx ou .xls');
	            return;
	        }
	
	        // Afficher la progression
	        progressSection.classList.remove('hidden');
	        resultsSection.classList.add('hidden');
	
	        // Pr√©parer le formulaire
	        const formData = new FormData();
	        formData.append('excelFile', file);
	
	        // Simulation de progression
	        let progress = 0;
	        const progressInterval = setInterval(() => {
	            progress += Math.random() * 20;
	            if (progress > 90) progress = 90;
	            updateProgress(progress);
	        }, 200);
	
	        // Upload
	        fetch('/directeur/import-excel/process', {
	            method: 'POST',
	            body: formData
	        })
	        .then(response => response.json())
	        .then(data => {
	            clearInterval(progressInterval);
	            updateProgress(100);
	            
	            setTimeout(() => {
	                progressSection.classList.add('hidden');
	                showResults(data);
	            }, 500);
	        })
	        .catch(error => {
	            clearInterval(progressInterval);
	            progressSection.classList.add('hidden');
	            console.error('Erreur:', error);
	            alert('Erreur lors de l\'upload: ' + error.message);
	        });
	    }
	
	    function updateProgress(percent) {
	        progressBar.style.width = percent + '%';
	        progressText.textContent = Math.round(percent) + '%';
	    }
	
	    function showResults(data) {
	        resultsSection.classList.remove('hidden');
	        
	        if (data.success) {
	            const results = data.results;
	            resultsContent.innerHTML = `
	                <div class="space-y-4">
	                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
	                        <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
	                            <div class="text-2xl font-bold text-green-600">${results.success}</div>
	                            <div class="text-sm text-green-800">Succ√®s</div>
	                        </div>
	                        <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
	                            <div class="text-2xl font-bold text-red-600">${results.errors}</div>
	                            <div class="text-sm text-red-800">Erreurs</div>
	                        </div>
	                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
	                            <div class="text-2xl font-bold text-blue-600">${results.success + results.errors}</div>
	                            <div class="text-sm text-blue-800">Total lignes</div>
	                        </div>
	                    </div>
	                    
	                    ${results.details.length > 0 ? `
	                        <div class="mt-6">
	                            <h4 class="font-medium text-gray-900 mb-3">D√©tails de l'import:</h4>
	                            <div class="max-h-64 overflow-y-auto border border-gray-200 rounded-lg">
	                                <table class="min-w-full divide-y divide-gray-200">
	                                    <thead class="bg-gray-50">
	                                        <tr>
	                                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Ligne</th>
	                                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
	                                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Famille</th>
	                                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Enfant</th>
	                                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Classe</th>
	                                        </tr>
	                                    </thead>
	                                    <tbody class="bg-white divide-y divide-gray-200">
	                                        ${results.details.slice(0, 50).map(detail => `
	                                            <tr class="hover:bg-gray-50">
	                                                <td class="px-3 py-2 text-sm text-gray-900">${detail.ligne}</td>
	                                                <td class="px-3 py-2 text-sm">
	                                                    ${detail.status === 'success' 
	                                                        ? '<span class="text-green-600">‚úì Succ√®s</span>' 
	                                                        : '<span class="text-red-600">‚úó Erreur</span>'
	                                                    }
	                                                </td>
	                                                <td class="px-3 py-2 text-sm text-gray-900">${detail.famille || '-'}</td>
	                                                <td class="px-3 py-2 text-sm text-gray-900">${detail.enfant || '-'}</td>
	                                                <td class="px-3 py-2 text-sm text-gray-900">${detail.classe || detail.erreur || '-'}</td>
	                                            </tr>
	                                        `).join('')}
	                                    </tbody>
	                                </table>
	                            </div>
	                            ${results.details.length > 50 ? `
	                                <p class="text-sm text-gray-500 mt-2">
	                                    Affichage des 50 premiers r√©sultats sur ${results.details.length} total.
	                                </p>
	                            ` : ''}
	                        </div>
	                    ` : ''}
	                </div>
	            `;
	        } else {
	            resultsContent.innerHTML = `
	                <div class="bg-red-50 border border-red-200 rounded-lg p-4">
	                    <div class="flex">
	                        <div class="flex-shrink-0">
	                            <svg class="h-5 w-5 text-red-400" fill="currentColor" viewBox="0 0 20 20">
	                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
	                            </svg>
	                        </div>
	                        <div class="ml-3">
	                            <h3 class="text-sm font-medium text-red-800">Erreur d'import</h3>
	                            <p class="text-sm text-red-700 mt-1">${data.message}</p>
	                        </div>
	                    </div>
	                </div>
	            `;
	        }
	    }
	});
	</script>
	{% endblock %}
