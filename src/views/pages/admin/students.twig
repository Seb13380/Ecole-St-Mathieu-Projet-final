{% extends "layouts/admin.twig" %}

{% block title %}
	{{ title }}
{% endblock %}

{% block content %}
	<div
		class="container mx-auto px-4 py-6">
		<!-- En-tête -->
		<div class="mb-6">
			<h1 class="text-3xl font-bold text-gray-800 mb-2">{{ title }}</h1>
			<p class="text-gray-600">Gérez les élèves de l'école</p>
		</div>

		<!-- Messages -->
		{% if success %}
			<div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
				{{ success }}
			</div>
		{% endif %}

		{% if error %}
			<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
				{{ error }}
			</div>
		{% endif %}

		<!-- Bouton Créer élève -->
		<div class="mb-6">
			<button id="addStudentBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
				<i class="fas fa-plus mr-2"></i>Ajouter un élève
			</button>
		</div>

		<!-- Tableau des élèves -->
		<div class="bg-white shadow-md rounded-lg overflow-hidden">
			<table class="min-w-full divide-y divide-gray-200">
				<thead class="bg-gray-50">
					<tr>
						<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
							Nom de l'élève
						</th>
						<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
							Date de naissance
						</th>
						<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
							Classe
						</th>
						<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
							Parent
						</th>
						<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
							Notes/Absences
						</th>
						<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
							Actions
						</th>
					</tr>
				</thead>
				<tbody class="bg-white divide-y divide-gray-200">
					{% for student in students %}
						<tr>
							<td class="px-6 py-4 whitespace-nowrap">
								<div class="flex items-center">
									<div class="ml-4">
										<div class="text-sm font-medium text-gray-900">
											{{ student.firstName }}
											{{ student.lastName }}
										</div>
									</div>
								</div>
							</td>
							<td class="px-6 py-4 whitespace-nowrap">
								<div class="text-sm text-gray-900">
									{{ student.dateNaissance|date('d/m/Y') }}
								</div>
								<div class="text-sm text-gray-500">
									{% set age = "now"|date('Y') - student.dateNaissance|date('Y') %}
									{{ age }}
									ans
								</div>
							</td>
							<td class="px-6 py-4 whitespace-nowrap">
								{% if student.classe %}
									<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
										{{ student.classe.nom }}
									</span>
									<div class="text-sm text-gray-500">{{ student.classe.niveau }}</div>
								{% else %}
									<span class="text-gray-400">Non assigné</span>
								{% endif %}
							</td>
							<td class="px-6 py-4 whitespace-nowrap">
								{% if student.parent %}
									<div class="text-sm text-gray-900">
										{{ student.parent.firstName }}
										{{ student.parent.lastName }}
									</div>
									<div class="text-sm text-gray-500">{{ student.parent.email }}</div>
								{% else %}
									<span class="text-gray-400">Aucun parent</span>
								{% endif %}
							</td>
							<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
								<div class="flex space-x-4">
									<span class="text-blue-600">{{ student._count.notes }}
										notes</span>
									<span class="text-red-600">{{ student._count.absences }}
										absences</span>
								</div>
							</td>
							<td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
								<button onclick="editStudent({{ student.id }})" class="text-indigo-600 hover:text-indigo-900 mr-3">
									<i class="fas fa-edit"></i>
								</button>
								<button onclick="deleteStudent({{ student.id }})" class="text-red-600 hover:text-red-900">
									<i class="fas fa-trash"></i>
								</button>
							</td>
						</tr>
					{% endfor %}
				</tbody>
			</table>

			{% if students|length == 0 %}
				<div class="text-center py-8">
					<p class="text-gray-500">Aucun élève enregistré</p>
				</div>
			{% endif %}
		</div>
	</div>

	<!-- Modal Ajouter/Modifier élève -->
	<div id="studentModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
		<div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
			<div class="mt-3">
				<h3 class="text-lg font-medium text-gray-900 mb-4" id="modalTitle">Ajouter un élève</h3>
				<form id="studentForm" action="/admin/students" method="POST">
					<input type="hidden" id="studentId" name="studentId">

					<div class="mb-4">
						<label class="block text-sm font-medium text-gray-700 mb-2">Prénom</label>
						<input type="text" id="firstName" name="firstName" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
					</div>

					<div class="mb-4">
						<label class="block text-sm font-medium text-gray-700 mb-2">Nom</label>
						<input type="text" id="lastName" name="lastName" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
					</div>

					<div class="mb-4">
						<label class="block text-sm font-medium text-gray-700 mb-2">Date de naissance</label>
						<input type="date" id="dateNaissance" name="dateNaissance" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
					</div>

					<div class="mb-4">
						<label class="block text-sm font-medium text-gray-700 mb-2">Classe</label>
						<select id="classeId" name="classeId" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
							<option value="">Sélectionner une classe</option>
							{% for classe in classes %}
								<option value="{{ classe.id }}">{{ classe.nom }}
									-
									{{ classe.niveau }}</option>
							{% endfor %}
						</select>
					</div>

					<div class="mb-4">
						<label class="block text-sm font-medium text-gray-700 mb-2">Parent</label>
						<select id="parentId" name="parentId" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
							<option value="">Sélectionner un parent</option>
							{% for parent in parents %}
								<option value="{{ parent.id }}">{{ parent.firstName }}
									{{ parent.lastName }}</option>
							{% endfor %}
						</select>
					</div>

					<div class="flex justify-end space-x-3">
						<button type="button" id="cancelBtn" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
							Annuler
						</button>
						<button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
							Enregistrer
						</button>
					</div>
				</form>
			</div>
		</div>
	</div>

	<script>
		let isEditMode = false;
let currentStudentId = null;

// Ouvrir le modal pour ajouter
document.getElementById('addStudentBtn').addEventListener('click', function () {
isEditMode = false;
document.getElementById('modalTitle').textContent = 'Ajouter un élève';
document.getElementById('studentForm').reset();
document.getElementById('studentId').value = '';
document.getElementById('studentForm').action = '/admin/students';
document.getElementById('studentModal').classList.remove('hidden');
});

// Fermer le modal
document.getElementById('cancelBtn').addEventListener('click', function () {
document.getElementById('studentModal').classList.add('hidden');
});

// Éditer un élève
function editStudent(studentId) {
isEditMode = true;
currentStudentId = studentId;
document.getElementById('modalTitle').textContent = 'Modifier l\'élève';
document.getElementById('studentForm').action = `/admin/students/${studentId}/update`;

// Ici il faudrait récupérer les données de l'élève pour pré-remplir le formulaire
document.getElementById('studentModal').classList.remove('hidden');
}

// Supprimer un élève
function deleteStudent(studentId) {
if (confirm('Êtes-vous sûr de vouloir supprimer cet élève ? Toutes ses notes et absences seront également supprimées.')) { // Créer un formulaire pour la suppression
const form = document.createElement('form');
form.method = 'POST';
form.action = `/admin/students/${studentId}/delete`;
document.body.appendChild(form);
form.submit();
}
}
	</script>
{% endblock %}
