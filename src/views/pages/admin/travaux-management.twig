{% extends "layouts/admin.twig" %}

{% block title %}
	{{ title }}
{% endblock %}

{% block content %}
	<div
		class="container mx-auto px-4 py-6">
		<!-- En-tête -->
		<div class="mb-6">
			<h1 class="text-3xl font-bold text-gray-800 mb-2">{{ title }}</h1>
			<p class="text-gray-600">Gérez les travaux et projets de l'école</p>
		</div>

		<!-- Messages -->
		{% if success %}
			<div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
				{{ success }}
			</div>
		{% endif %}

		{% if error %}
			<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
				{{ error }}
			</div>
		{% endif %}

		<!-- Bouton Créer travail -->
		<div class="mb-6">
			<button id="addTravauxBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
				<i class="fas fa-plus mr-2"></i>Ajouter un travail
			</button>
		</div>

		<!-- Liste des travaux -->
		<div class="grid gap-6">
			{% for travail in travaux %}
				<div class="bg-white shadow-md rounded-lg p-6 border-l-4 {% if travail.important %}border-red-500{% else %}border-blue-500{% endif %}">
					<div class="flex justify-between items-start mb-4">
						<div class="flex-1">
							<h3 class="text-xl font-bold text-gray-800 mb-2">
								{{ travail.titre }}
								{% if travail.important %}
									<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800 ml-2">
										<i class="fas fa-exclamation-triangle mr-1"></i>Important
									</span>
								{% endif %}
							</h3>

							{% if travail.description %}
								<p class="text-gray-600 mb-3">{{ travail.description }}</p>
							{% endif %}

							<div class="flex flex-wrap gap-4 text-sm text-gray-500">
								{% if travail.dateDebut %}
									<span>
										<i class="fas fa-calendar-start mr-1"></i>Début:
										{{ travail.dateDebutFormatted }}</span>
								{% endif %}

								{% if travail.dateFin %}
									<span>
										<i class="fas fa-calendar-check mr-1"></i>Fin:
										{{ travail.dateFinFormatted }}</span>
								{% endif %}

								{% if travail.auteur %}
									<span>
										<i class="fas fa-user mr-1"></i>
										{{ travail.auteur.firstName }}
										{{ travail.auteur.lastName }}</span>
								{% endif %}
							</div>
						</div>

						<div
							class="flex flex-col items-end space-y-2">
							<!-- Statut -->
							<span class="px-3 py-1 rounded-full text-sm font-medium
									                        {% if travail.statut == 'TERMINE' %}
									                            bg-green-100 text-green-800
									                        {% elseif travail.statut == 'EN_COURS' %}
									                            bg-blue-100 text-blue-800
									                        {% elseif travail.statut == 'EN_ATTENTE' %}
									                            bg-yellow-100 text-yellow-800
									                        {% else %}
									                            bg-gray-100 text-gray-800
									                        {% endif %}">
								{{ travail.statut|replace('_', ' ') }}
							</span>

							<!-- Visibilité -->
							<span class="px-2 py-1 rounded text-xs
									                        {% if travail.visible %}
									                            bg-green-100 text-green-600
									                        {% else %}
									                            bg-gray-100 text-gray-600
									                        {% endif %}">
								{% if travail.visible %}Visible{% else %}Masqué
								{% endif %}
							</span>
						</div>
					</div>

					<!-- Barre de progression -->
					{% if travail.progression is defined and travail.progression > 0 %}
						<div class="mb-4">
							<div class="flex justify-between text-sm text-gray-600 mb-1">
								<span>Progression</span>
								<span>{{ travail.progressionPercent }}%</span>
							</div>
							<div class="w-full bg-gray-200 rounded-full h-2">
								<div class="bg-blue-600 h-2 rounded-full" style="width: {{ travail.progressionPercent }}%"></div>
							</div>
						</div>
					{% endif %}

					<!-- Actions -->
					<div class="flex justify-end space-x-2">
						<button onclick="editTravail({{ travail.id }}, '{{ travail.titre|e('js') }}', '{{ travail.description|e('js') }}', '{{ travail.dateDebutFormatted }}', '{{ travail.dateFinFormatted }}', {{ travail.progression }}, '{{ travail.statut }}', {{ travail.important ? 'true' : 'false' }}, {{ travail.visible ? 'true' : 'false' }})" class="text-indigo-600 hover:text-indigo-900">
							<i class="fas fa-edit mr-1"></i>Modifier
						</button>
						<button onclick="toggleVisibility({{ travail.id }}, {{ travail.visible ? 'false' : 'true' }})" class="text-blue-600 hover:text-blue-900">
							<i class="fas fa-eye{% if not travail.visible %}-slash{% endif %} mr-1"></i>
							{% if travail.visible %}Masquer{% else %}Afficher
							{% endif %}
						</button>
						<button onclick="deleteTravail({{ travail.id }})" class="text-red-600 hover:text-red-900">
							<i class="fas fa-trash mr-1"></i>Supprimer
						</button>
					</div>
				</div>
			{% endfor %}

			{% if travaux|length == 0 %}
				<div class="text-center py-12 bg-white rounded-lg shadow">
					<i class="fas fa-hammer text-4xl text-gray-400 mb-4"></i>
					<h3 class="text-lg font-medium text-gray-900 mb-2">Aucun travail</h3>
					<p class="text-gray-500">Commencez par ajouter un premier travail</p>
				</div>
			{% endif %}
		</div>
	</div>

	<!-- Modal Ajouter/Modifier travail -->
	<div id="travauxModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
		<div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
			<div class="mt-3">
				<h3 class="text-lg font-medium text-gray-900 mb-4" id="modalTitle">Ajouter un travail</h3>
				<form id="travauxForm" action="/travaux/create" method="POST">
					<input type="hidden" id="travauxId" name="travauxId">

					<div class="mb-4">
						<label class="block text-sm font-medium text-gray-700 mb-2">Titre *</label>
						<input type="text" id="titre" name="titre" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
					</div>

					<div class="mb-4">
						<label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
						<textarea id="description" name="description" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
					</div>

					<div class="grid grid-cols-2 gap-4 mb-4">
						<div>
							<label class="block text-sm font-medium text-gray-700 mb-2">Date début</label>
							<input type="date" id="dateDebut" name="dateDebut" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
						</div>
						<div>
							<label class="block text-sm font-medium text-gray-700 mb-2">Date fin</label>
							<input type="date" id="dateFin" name="dateFin" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
						</div>
					</div>

					<div class="grid grid-cols-2 gap-4 mb-4">
						<div>
							<label class="block text-sm font-medium text-gray-700 mb-2">Progression (%)</label>
							<input type="range" id="progression" name="progression" min="0" max="100" value="0" class="w-full" oninput="document.getElementById('progressionValue').textContent = this.value + '%'">
							<div class="text-center text-sm text-gray-600">
								<span id="progressionValue">0%</span>
							</div>
						</div>
						<div>
							<label class="block text-sm font-medium text-gray-700 mb-2">Statut</label>
							<select id="statut" name="statut" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
								<option value="EN_ATTENTE">En attente</option>
								<option value="EN_COURS" selected>En cours</option>
								<option value="TERMINE">Terminé</option>
							</select>
						</div>
					</div>

					<div class="mb-4">
						<div class="flex items-center space-x-4">
							<label class="flex items-center">
								<input type="checkbox" id="important" name="important" class="rounded">
								<span class="ml-2 text-sm text-gray-700">Travail important</span>
							</label>
							<label class="flex items-center">
								<input type="checkbox" id="visible" name="visible" checked class="rounded">
								<span class="ml-2 text-sm text-gray-700">Visible publiquement</span>
							</label>
						</div>
					</div>

					<div class="flex justify-end space-x-3">
						<button type="button" id="cancelBtn" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
							Annuler
						</button>
						<button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
							Enregistrer
						</button>
					</div>
				</form>
			</div>
		</div>
	</div>

	<script>
		let isEditMode = false;
let currentTravauxId = null;

// Ouvrir le modal pour ajouter
document.getElementById('addTravauxBtn').addEventListener('click', function () {
isEditMode = false;
document.getElementById('modalTitle').textContent = 'Ajouter un travail';
document.getElementById('travauxForm').reset();
document.getElementById('travauxForm').action = '/travaux/create';
document.getElementById('progressionValue').textContent = '0%';
document.getElementById('travauxModal').classList.remove('hidden');
});

// Fermer le modal
document.getElementById('cancelBtn').addEventListener('click', function () {
document.getElementById('travauxModal').classList.add('hidden');
});

// Éditer un travail
function editTravail(travauxId, titre, description, dateDebut, dateFin, progression, statut, important, visible) {
	isEditMode = true;
	currentTravauxId = travauxId;
	document.getElementById('modalTitle').textContent = 'Modifier le travail';
	document.getElementById('travauxForm').action = `/travaux/${travauxId}/update`;

	// Pré-remplir le formulaire avec les données
	document.getElementById('titre').value = titre || '';
	document.getElementById('description').value = description || '';
	document.getElementById('dateDebut').value = dateDebut || '';
	document.getElementById('dateFin').value = dateFin || '';
	document.getElementById('progression').value = progression || 0;
	document.getElementById('statut').value = statut || 'EN_COURS';
	document.getElementById('important').checked = important === true || important === 'true';
	document.getElementById('visible').checked = visible === true || visible === 'true';
	
	// Mettre à jour l'affichage de la progression
	document.getElementById('progressionValue').textContent = (progression || 0) + '%';

	document.getElementById('travauxModal').classList.remove('hidden');
}// Basculer la visibilité
function toggleVisibility(travauxId, newVisibility) {
const form = document.createElement('form');
form.method = 'POST';
form.action = `/travaux/${travauxId}/toggle-visibility`;
document.body.appendChild(form);
form.submit();
}

// Supprimer un travail
function deleteTravail(travauxId) {
if (confirm('Êtes-vous sûr de vouloir supprimer ce travail ?')) {
const form = document.createElement('form');
form.method = 'POST';
form.action = `/travaux/${travauxId}/delete`;
document.body.appendChild(form);
form.submit();
}
}

// Fermer le modal en cliquant à l'extérieur
document.getElementById('travauxModal').addEventListener('click', function (e) {
if (e.target === this) {
this.classList.add('hidden');
}
});
	</script>
{% endblock %}
