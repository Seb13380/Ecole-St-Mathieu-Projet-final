{% extends "layouts/base.twig" %}

{% block title %}D√©tails de la demande - Administration
{% endblock %}

{% block main %}
	<div class="container mx-auto px-4 py-8">
		<div
			class="max-w-4xl mx-auto">
			<!-- En-t√™te -->
			<div class="flex justify-between items-center mb-8">
				<h1 class="text-3xl font-bold text-[#304a4d]">D√©tails de la demande d'inscription</h1>
				<a href="/directeur/inscriptions" class="btn btn-ghost">
					‚Üê Retour aux demandes
				</a>
			</div>

			<!-- Statut de la demande -->
			<div class="card bg-base-100 shadow-xl mb-6">
				<div class="card-body">
					<div class="flex justify-between items-center">
						<h2 class="card-title">Statut de la demande</h2>
						{% if request.status == 'PENDING' %}
							<span class="badge badge-warning badge-lg">En attente</span>
						{% elseif request.status == 'APPROVED' %}
							<span class="badge badge-success badge-lg">Approuv√©e</span>
						{% else %}
							<span class="badge badge-error badge-lg">Refus√©e</span>
						{% endif %}
					</div>
					<p class="text-sm text-gray-500">
						Demande cr√©√©e le
						{{ request.createdAt | date('d/m/Y √† H:i') }}
					</p>
					{% if request.reviewedAt %}
						<p class="text-sm text-gray-500">
							Trait√©e le
							{{ request.reviewedAt | date('d/m/Y √† H:i') }}
							{% if request.reviewer %}
								par
								{{ request.reviewer.firstName }}
								{{ request.reviewer.lastName }}
							{% endif %}
						</p>
					{% endif %}
				</div>
			</div>

			<!-- Informations du parent -->
			<div class="card bg-base-100 shadow-xl mb-6">
				<div class="card-body">
					<h2 class="card-title text-[#304a4d] mb-4">
						üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Informations du parent
					</h2>
					<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
						<div>
							<p class="font-semibold">Nom complet</p>
							<p>{{ request.parentFirstName }}
								{{ request.parentLastName }}</p>
						</div>
						<div>
							<p class="font-semibold">Email</p>
							<p>{{ request.parentEmail }}</p>
						</div>
						<div>
							<p class="font-semibold">T√©l√©phone</p>
							<p>{{ request.parentPhone }}</p>
						</div>
						<div>
							<p class="font-semibold">Adresse</p>
							<p>{{ request.parentAddress }}</p>
						</div>
					</div>
				</div>
			</div>

			<!-- Informations des enfants -->
			<div class="card bg-base-100 shadow-xl mb-6">
				<div class="card-body">
					<h2 class="card-title text-[#304a4d] mb-4">
						üë∂ Enfant(s) √† inscrire
					</h2>
					<div class="space-y-4">
						{% for child in request.children %}
							<div class="border rounded-lg p-4 bg-gray-50">
								<p class="font-semibold text-lg">
									{{ child.firstName }}
									{{ child.lastName }}
								</p>
								<p class="text-gray-600">
									Date de naissance :
									{{ child.birthDate | date('d/m/Y') }}
								</p>
								<p class="text-gray-600">
									√Çge :
									{{ 'now' | date('Y') - child.birthDate | date('Y') }}
									ans
								</p>
							</div>
						{% endfor %}
					</div>
				</div>
			</div>

			<!-- Commentaire de r√©vision -->
			{% if request.reviewComment %}
				<div class="card bg-base-100 shadow-xl mb-6">
					<div class="card-body">
						<h2 class="card-title text-[#304a4d] mb-4">
							üí¨ Commentaire de r√©vision
						</h2>
						<p>{{ request.reviewComment }}</p>
					</div>
				</div>
			{% endif %}

			<!-- Actions -->
			{% if request.status == 'PENDING' %}
				<div class="card bg-base-100 shadow-xl">
					<div class="card-body">
						<h2 class="card-title text-[#304a4d] mb-4">
							‚ö° Actions disponibles
						</h2>
						<div class="flex gap-4">
							<button class="btn btn-success" onclick="showApproveModal({{ request.id }})">
								‚úÖ Approuver la demande
							</button>
							<button class="btn btn-error" onclick="showRejectModal({{ request.id }})">
								‚ùå Refuser la demande
							</button>
						</div>
					</div>
				</div>
			{% endif %}
		</div>
	</div>

	<!-- Modals -->
	<dialog id="approve_modal" class="modal">
		<div class="modal-box">
			<h3 class="font-bold text-lg text-green-600">Approuver la demande</h3>
			<p class="py-4">√ätes-vous s√ªr de vouloir approuver cette demande ?</p>
			<div class="form-control">
				<label class="label">
					<span class="label-text">Commentaire (optionnel)</span>
				</label>
				<textarea id="approve_comment" class="textarea textarea-bordered" placeholder="Commentaire..."></textarea>
			</div>
			<div class="modal-action">
				<button class="btn" onclick="document.getElementById('approve_modal').close()">Annuler</button>
				<button class="btn btn-success" onclick="processApproval()">Confirmer</button>
			</div>
		</div>
	</dialog>

	<dialog id="reject_modal" class="modal">
		<div class="modal-box">
			<h3 class="font-bold text-lg text-red-600">Refuser la demande</h3>
			<p class="py-4">Veuillez indiquer le motif du refus.</p>
			<div class="form-control">
				<label class="label">
					<span class="label-text">Motif du refus *</span>
				</label>
				<textarea id="reject_comment" class="textarea textarea-bordered" placeholder="Motif..." required></textarea>
			</div>
			<div class="modal-action">
				<button class="btn" onclick="document.getElementById('reject_modal').close()">Annuler</button>
				<button class="btn btn-error" onclick="processRejection()">Confirmer</button>
			</div>
		</div>
	</dialog>

	<script>
		let currentRequestId = {{ request.id }};

function showApproveModal() {
document.getElementById('approve_modal').showModal();
}

function showRejectModal() {
document.getElementById('reject_modal').showModal();
}

async function processApproval() {
const comment = document.getElementById('approve_comment').value;

try {
const response = await fetch (`/directeur/inscriptions/${currentRequestId}/approve`, {
method: 'POST',
headers: {
'Content-Type': 'application/json'
},
credentials: 'include',
body: JSON.stringify({comment})
});
const result = await response.json();

if (result.success) {
alert('‚úÖ Demande approuv√©e avec succ√®s !');
window.location.href = '/directeur/inscriptions';
} else {
alert('‚ùå Erreur : ' + result.message);
}
} catch (error) {
alert('‚ùå Erreur lors de l\'approbation');
console.error(error);
}
}

async function processRejection() {
const comment = document.getElementById('reject_comment').value;

if (! comment.trim()) {
alert('Veuillez indiquer un motif de refus');
return;
}

try {
const response = await fetch (`/directeur/inscriptions/${currentRequestId}/reject`, {
method: 'POST',
headers: {
'Content-Type': 'application/json'
},
credentials: 'include',
body: JSON.stringify({comment})
});
const result = await response.json();

if (result.success) {
alert('‚úÖ Demande refus√©e');
window.location.href = '/directeur/inscriptions';
} else {
alert('‚ùå Erreur : ' + result.message);
}
} catch (error) {
alert('‚ùå Erreur lors du refus');
console.error(error);
}
}
	</script>
{% endblock %}
